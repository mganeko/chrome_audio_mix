<!DOCTYPE html>
<html>
<head>
  <meta charset="utf8" />
  <title>audiomix</title>
</head>
<body>
  hello
  <div>
    <label for="audio_file">Audio File</label>
    <input type="file" accept="audio/*" id="audiofile" onchange="loadAudio()" />
    <!--
    <button id="load_button" onclick="loadAudio()">load</button>
    -->
    <button id="play_button" onclick="playAudio()" disabled>play</button>
    <br />
    Audio Gain: <input type="range" id="audio_file_range" min="0" max="100" value="80" step="1" onchange="changeAudioFileGain()"> Max
    &nbsp;&nbsp;
    <input type="checkbox" id="playback_check" onchange="togglePlayback()" checked>Playback</input>
    <br />
    <br />
    <audio id="audio_playback" controls="1" width="200px" height="80px"></audio><br />
    <br />
    <button id="mix_button" onclick="startMixedStream()">start media & mix</button><br />
    <video id="local_video" controls="1" width="240px" height="180px" style="border: solid black 1px"></video><br />
    Balance: Device <input type="range" id="mix_range" min="0" max="100" value="50" step="1" onchange="changeMixGain()"> File <br />
  </div>
</body>
<script>
  "use strict"

  // ---- init ----
  let audioContext = null;
  const audioFileInput = document.getElementById('audiofile');
  const audioElement = document.getElementById('audio_playback');
  const videoElement = document.getElementById('local_video');
  const audioFileRange = document.getElementById('audio_file_range');
  const playbackCheck = document.getElementById('playback_check');
  const mixRange = document.getElementById('mix_range');
  
  let audioSourceBuffer = null;
  let audioSource = null;
  let audioSourceGain = null;

  let deviceStream = null;
  let audioStream = null;
  let deviceSource = null;
  let deviceGain = null;
  let audioGain = null;

  let mixedOutput = null;
  let mixedStream = null;
  
  
  function startMixedStream() {
    audioElement.pause();

    navigator.mediaDevices.getUserMedia({video:true, audio:true})
    .then(stream => {
      deviceStream = stream;
      //mixedStream = prepareMixStream(deviceStream, audioSource);
      mixedStream = prepareMixStream(deviceStream, audioSourceGain);
      playMedia(videoElement, mixedStream, 0.4);
    })
    .catch(err => {
      console.error('UserMedia ERROR:', err);
    })
  }

  function prepareMixStream(stream, source) {
    const mixStream = new MediaStream();

    // --- video track ---
    const videoTrack = stream.getVideoTracks()[0];
    if (videoTrack) {
      mixStream.addTrack(videoTrack);
    }

    // --- audio track ---
    // -- device --
    deviceSource = audioContext.createMediaStreamSource(stream);
    deviceGain = audioContext.createGain();
    deviceGain.gain.value = 0.5;
    deviceSource.connect(deviceGain);

    // -- audio file --
    audioGain = audioContext.createGain();
    audioGain.gain.value = 0.5;
    source.connect(audioGain);

    // -- mix --
    mixedOutput = audioContext.createMediaStreamDestination();
    const mediaStream = mixedOutput.stream;
    deviceGain.connect(mixedOutput);
    audioGain.connect(mixedOutput);

    // ---- new media stream --
    const autioTrack = mediaStream.getAudioTracks()[0];
    if(autioTrack) {
      mixStream.addTrack(autioTrack);
    }
    else {
      console.error('Mix Audio ERROR');
    }

    return mixStream;
  }

  function changeMixGain() {
    const mixValue = mixRange.value;
    if (deviceGain) {
      deviceGain.gain.value = (100 - mixValue) / 100.0;
    }
    if (audioGain) {
      audioGain.gain.value = (mixValue) / 100.0;
    }
  }

  function changeAudioFileGain() {
    if (audioSourceGain) {
      audioSourceGain.gain.value = (audioFileRange.value / 100.0)
    }
  }

  function loadAudio() {
    if (! audioContext) {
      audioContext = new AudioContext();
    }

    // --- file ---
    if (audioFileInput.files.length == 0) {
      console.warn('file not selected');
      return;
    }

    const audioFileToPlay = audioFileInput.files[0];
    console.log(audioFileToPlay);

    disableElement('play_button')
    loadLocalAudio(audioFileToPlay).then(buffer => {
      audioSourceBuffer = buffer;
      enabelElement('play_button')
    })
    .catch(err => {
      console.error('load audio file ERROR:', err);
    })
  }

  function playAudio() {
    audioStream = startAudioStream();
    if (playbackCheck.checked) {
      // モニター用出力
      audioSourceGain.connect(audioContext.destination);
    
      // エレメント出力
      if (audioStream) {
        //playMedia(audioElement, audioStream, 0.5);
      }
    }
  }

  function togglePlayback() {
    if (playbackCheck.checked) {
      // モニター用出力
      audioSourceGain.connect(audioContext.destination);
    }
    else {
      audioSourceGain.disconnect(audioContext.destination);
    }
  }


  function startAudioStream() {
    const audioOutput = audioContext.createMediaStreamDestination();
    const mediaStream = audioOutput.stream;
    audioSourceGain = audioContext.createGain();
    audioSourceGain.gain.value = (audioFileRange.value / 100.0)
    audioSourceGain.connect(audioOutput);


    // source を作成
    audioSource = audioContext.createBufferSource();
    audioSource.buffer = audioSourceBuffer;
    audioSource.loop　= true;
    audioSource.connect(audioSourceGain);

    // 開始
    audioSource.start(0);

    // ファイルからのストリームを返す
    return mediaStream;
  }

  function loadLocalAudio(file) {    
    let reader = new FileReader;
    reader.readAsArrayBuffer(file);
    return new Promise((resolve, reject) => {
      reader.onload = function(evt) {
        console.log('reader.onload(), evt:', evt);
        audioContext.decodeAudioData(reader.result)
        .then(buffer => {
          console.log('buffer ready');
          resolve(buffer);
        })
        .catch(err => {
          reject(err);
        })
      }
      reader.onloadend = function(evt) {
        console.log('reader.onloadend(), evt:', evt);
      }
      reader.onloadstart = function(evt) {
        console.log('reader.onloadstart(), evt:', evt);
      }
    })
  }

function playMedia(element, stream, volume = 0) {
  element.srcObject = stream;
  element.play().catch(err => console.error('Media Play Error:', err));
  element.volume = volume;
}

function enabelElement(id) {
  let element = document.getElementById(id);
  if (element) {
    element.removeAttribute('disabled');
  }
}

function disableElement(id) {
  let element = document.getElementById(id);
  if (element) {
    element.setAttribute('disabled', '1');
  }
}

</script>
</html>